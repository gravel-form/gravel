{"version":3,"sources":["utils.tsx"],"names":[],"mappings":"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","file":"utils.js","sourcesContent":["import React from 'react';\nimport { JSONSchema7Definition, JSONSchema7 } from 'json-schema';\nimport compose, { MiddlewareProps } from './compose';\nimport { traverse, getSchemaByPointer } from './json-schema-traverse';\n\ninterface SchemaLocalRef {\n  schema: JSONSchema7Definition;\n  path: (string | number)[];\n}\n\nexport interface FormMiddlewareProps<FP = {}> extends MiddlewareProps {\n  schema: JSONSchema7Definition;\n  parent: FormMiddlewareProps | null;\n  data: unknown;\n  onChange: Function;\n  schemaPath: (string | number)[];\n  dataPath: (string | number)[];\n  MiddlewareComponent: React.ComponentType<FormMiddlewareProps>;\n  formProps: FormProps & FP;\n  localRefs?: { [key: string]: SchemaLocalRef };\n}\n\nexport interface FormProps {\n  schema: JSONSchema7;\n  middlewares: React.ComponentType<FormMiddlewareProps> | React.ComponentType<FormMiddlewareProps>[];\n  data?: unknown;\n  onChange?: (data: unknown) => void;\n}\n\nconst noop = () => {};\n\nconst Null = () => null;\n\nexport function toJSONSchemaPath(dataPath: (string | number)[]): string {\n  return dataPath.map((key) => (typeof key === 'number' ? `[${key}]` : '.' + key)).join('');\n}\n\nexport function isRequired({ parent, dataPath }: FormMiddlewareProps): boolean {\n  const field = dataPath[dataPath.length - 1];\n  return !!(\n    parent &&\n    typeof parent.schema !== 'boolean' &&\n    parent.schema.required &&\n    typeof field === 'string' &&\n    parent.schema.required.includes(field)\n  );\n}\n\nexport const FixedObjectMw: React.FC<FormMiddlewareProps> = (props) => {\n  const { schema, schemaPath, dataPath, onChange, MiddlewareComponent, next } = props;\n  if (typeof schema === 'boolean' || schema.type !== 'object') return next(props);\n  const data: any = (typeof props.data === 'object' && props.data) || {};\n  const properties = schema.properties;\n  if (!properties) return next(props);\n  return (\n    <>\n      {Object.keys(properties).map((key) => (\n        <MiddlewareComponent\n          key={key}\n          {...props}\n          schema={properties[key]}\n          data={Object.hasOwnProperty.call(data, key) ? data[key] : undefined}\n          onChange={(value: unknown) => onChange({ ...data, [key]: value })}\n          schemaPath={[...schemaPath, 'properties', key]}\n          dataPath={[...dataPath, key]}\n          parent={props}\n          next={Null}\n        />\n      ))}\n    </>\n  );\n};\n\nexport const FixedArrayMw: React.FC<FormMiddlewareProps> = (props) => {\n  const { schema, schemaPath, dataPath, onChange, MiddlewareComponent, next } = props;\n  if (typeof schema === 'boolean' || schema.type !== 'array' || !schema.items || !Array.isArray(schema.items))\n    return next(props);\n  const data: unknown[] = (Array.isArray(props.data) && props.data) || [];\n  const items = schema.items;\n\n  return (\n    <>\n      {items.map((item, index) => (\n        <MiddlewareComponent\n          key={index}\n          {...props}\n          schema={items[index]}\n          data={item}\n          onChange={(value: unknown) => onChange([...data.slice(0, +index), value, ...data.slice(+index + 1)])}\n          schemaPath={[...schemaPath, 'items', index]}\n          dataPath={[...dataPath, index]}\n          parent={props}\n          next={Null}\n        />\n      ))}\n    </>\n  );\n};\n\nfunction resolveSchemaRef(\n  rootSchema: JSONSchema7,\n  refs: { [key: string]: SchemaLocalRef },\n  ref: string\n): SchemaLocalRef | null {\n  const stack: string[] = [];\n  let result: SchemaLocalRef | null = null;\n  let _ref: string = ref;\n  while (!stack.includes(_ref)) {\n    if (ref.startsWith('#/')) {\n      result = getSchemaByPointer(rootSchema, ref);\n    } else if (ref.startsWith('#')) {\n      const id = ref;\n      result = refs[id];\n    }\n    if (!result) return null;\n    if (typeof result.schema !== 'object' || !result.schema.$ref) {\n      return result;\n    }\n    stack.push(_ref);\n    _ref = result.schema.$ref;\n    result = null;\n  }\n  return null;\n}\n\nexport const LocalRefMw: React.FC<FormMiddlewareProps> = (props) => {\n  const { schema, formProps, next, MiddlewareComponent, localRefs } = props;\n\n  const refs: { [key: string]: SchemaLocalRef } = React.useMemo(() => {\n    if (localRefs) return localRefs;\n    const refs: { [key: string]: SchemaLocalRef } = {};\n    for (const ref of traverse(formProps.schema)) {\n      const $id = ref.schema.$id;\n      if (!$id || !$id.startsWith('#')) continue;\n      refs[$id] = ref;\n    }\n    return refs;\n  }, [formProps.schema, localRefs]);\n\n  const nextProps = refs !== localRefs ? props : { ...props, localRefs: refs };\n  if (typeof schema === 'boolean' || !schema.$ref || !schema.$ref.startsWith('#')) return next(nextProps);\n\n  const child = schema.$ref ? resolveSchemaRef(formProps.schema, refs, schema.$ref) : null;\n  //console.log(child);\n  //return next(nextProps);\n\n  if (!child || child.schema === schema) return next(nextProps);\n\n  return <MiddlewareComponent {...nextProps} schema={child.schema} schemaPath={child.path} />;\n};\n\nexport const schemaMws = [FixedObjectMw, FixedArrayMw, LocalRefMw];\n\nexport const FormCore: React.FC<FormProps> = (props) => {\n  const { schema, data, middlewares, onChange } = props;\n  const Composed = React.useMemo(() => (Array.isArray(middlewares) ? compose(middlewares) : middlewares), [\n    middlewares,\n  ]);\n  return (\n    <Composed\n      schema={schema}\n      onChange={onChange || noop}\n      data={data}\n      schemaPath={[]}\n      dataPath={[]}\n      parent={null}\n      next={Null}\n      MiddlewareComponent={Composed}\n      formProps={props}\n    />\n  );\n};\n\nexport default FormCore;\n"]}